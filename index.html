<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© - HR System</title>
  
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { 
      --bg-main: #f4f6f8;
      --bg-white: #ffffff;
      --bg-sidebar: #1a1a1a;
      --text-dark: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --primary: #000000;
      --green: #28a745;
      --red: #dc3545;
      --orange: #fd7e14;
      --blue: #007bff;
    }

    * { box-sizing: border-box; }

    body { 
        font-family: 'Tajawal', sans-serif; 
        background: var(--bg-main); 
        color: var(--text-dark); 
        margin: 0; 
        display: flex; 
        height: 100vh; 
        overflow: hidden; 
    }
    
    .sidebar { 
        width: 260px; 
        background: var(--bg-sidebar); 
        color: #fff;
        display: flex; 
        flex-direction: column; 
        padding: 20px 15px; 
        z-index: 1000; 
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        transition: 0.3s;
        flex-shrink: 0;
        height: 100vh;
        overflow-y: auto;
        position: fixed;
        right: 0;
        top: 0;
    }
    
    .sidebar-header { 
        text-align: center; 
        margin-bottom: 30px; 
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-header img { max-width: 80px; filter: brightness(0) invert(1); }
    
    .nav-btn { 
        padding: 12px 15px; 
        margin-bottom: 5px; 
        background: transparent; 
        border: none; 
        color: #b0b0b0; 
        text-align: right; 
        cursor: pointer; 
        border-radius: 6px; 
        font-size: 0.9rem; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        transition: 0.2s; 
        width: 100%; 
        font-weight: 500;
        white-space: nowrap;
    }
    .nav-btn i { width: 20px; text-align: center; }
    .nav-btn:hover { background: rgba(255,255,255,0.08); color: white; }
    .nav-btn.active { background: rgba(255,255,255,0.15); color: white; font-weight: bold; }
    
    .main-content { 
        flex: 1; 
        margin-right: 260px;
        padding: 25px; 
        overflow-y: auto; 
        scroll-behavior: smooth; 
        height: 100vh;
        position: relative;
    }

    .card { 
        background: var(--bg-white); 
        padding: 25px; 
        border-radius: 12px; 
        margin-bottom: 20px; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.04); 
        border: 1px solid var(--border-color);
        position: relative; 
    }
    .inactive-card { opacity: 0.7; background: #f9f9f9; } 

    .sub-tabs { 
        display: flex; 
        gap: 20px; 
        margin-bottom: 25px; 
        border-bottom: 2px solid var(--border-color); 
        padding-bottom: 0px;
        background: var(--bg-white);
        padding: 15px 15px 0 15px;
        border-radius: 12px 12px 0 0;
        overflow-x: auto;
    }
    .sub-tab { 
        padding: 10px 15px; 
        cursor: pointer; 
        background: transparent; 
        color: var(--text-light); 
        transition: 0.3s; 
        font-weight: bold;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        white-space: nowrap;
    }
    .sub-tab.active { 
        color: var(--primary); 
        border-bottom-color: var(--primary); 
    }

    input, select, textarea { 
        width: 100%; 
        padding: 12px 15px; 
        margin-bottom: 15px; 
        background: var(--bg-white); 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        color: var(--text-dark); 
        font-family: 'Tajawal'; 
        box-sizing: border-box; 
        transition: 0.2s;
        font-size: 1rem;
    }
    input:focus, select:focus { border-color: #888; outline: none; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
    label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-dark); font-size: 0.9rem; }
    .input-label-secondary { color: var(--text-light); font-size: 0.85rem; margin-bottom: 5px; }

    .btn { 
        width: 100%; 
        padding: 12px; 
        border-radius: 8px; 
        border: none; 
        font-weight: bold; 
        cursor: pointer; 
        display:flex; 
        justify-content:center; 
        align-items:center; 
        gap:8px; 
        margin-top:10px; 
        transition:0.2s; 
        font-size:1rem;
        white-space: nowrap;
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-gold { background: var(--primary); color: white; }
    .btn-green { background: var(--green); color: white; }
    .btn-red { background: var(--red); color: white; }
    .btn-orange { background: var(--orange); color: white; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-gray { background: #eee; color: #555; }
    .btn-sm { width: auto; padding: 8px 16px; font-size: 0.85rem; margin: 0; }
    .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-dark); }
    .btn-outline:hover { background: var(--bg-main); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; }
    .flex-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    .hidden { display: none !important; }
    
    .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block;}
    .bg-green { background: #d4edda; color: #155724; }
    .bg-red { background: #f8d7da; color: #721c24; }
    .bg-gray { background: #e2e3e5; color: #383d41; }
    .bg-orange { background: #fff3cd; color: #856404; }
    .bg-blue { background: #cce5ff; color: #004085; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
    .modal-overlay.open { display: flex; }
    .modal-box { background: var(--bg-white); padding: 30px; border-radius: 16px; width: 95%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto; }

    #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    .breadcrumb { color: var(--text-light); font-size: 0.9rem; }
    .breadcrumb span { color: var(--text-dark); font-weight: bold; }

    .toast-container { position: fixed; top: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--bg-white); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; min-width: 300px; animation: slideIn 0.3s ease; border-right: 4px solid var(--green); }
    .toast.error { border-right-color: var(--red); }
    .toast.warning { border-right-color: var(--orange); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .stat-card { background: var(--bg-white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid var(--border-color); text-align: center; }
    .stat-card i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
    .stat-card .number { font-size: 2rem; font-weight: bold; color: var(--text-dark); }
    .stat-card .label { color: var(--text-light); font-size: 0.9rem; }

    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--green); }
    input:checked + .slider:before { transform: translateX(24px); }

    .attendance-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
    .att-present { background: var(--green); color: white; }
    .att-absent { background: var(--red); color: white; }
    .att-half { background: var(--orange); color: white; }
    .attendance-btn:hover { transform: scale(1.05); }

    /* Counter Bar */
    .counter-bar { 
        background: var(--bg-white); 
        padding: 15px 25px; 
        border-radius: 12px; 
        margin-bottom: 20px; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
    }
    .counter-item { text-align: center; }
    .counter-item .number { font-size: 1.8rem; font-weight: bold; color: var(--primary); }
    .counter-item .label { color: var(--text-light); font-size: 0.9rem; }

    /* Checkbox styling */
    .custom-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

    /* Worker card with checkbox */
    .worker-card { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        padding: 15px; 
        margin-bottom: 10px;
        transition: 0.3s;
    }
    .worker-card:hover { background: #f8f9fa; }
    .worker-card.selected { background: #e3f2fd; border-right: 4px solid var(--blue); }

    /* Roles Table */
    .roles-table { width: 100%; border-collapse: collapse; }
    .roles-table th, .roles-table td { padding: 15px; text-align: right; border-bottom: 1px solid var(--border-color); }
    .roles-table th { background: var(--bg-main); font-weight: bold; }
    .roles-table tr:hover { background: #f8f9fa; }

    /* Progress bar for large exports */
    .progress-container { width: 100%; max-width: 400px; margin: 20px auto; }
    .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--green); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; }

    @media (max-width: 768px) {
        .sidebar { 
            position: fixed; 
            right: -260px; 
            height: 100vh; 
            transition: 0.3s;
            z-index: 1001;
        }
        .sidebar.active { right: 0; }
        .main-content { margin-right: 0; }
        .menu-toggle { 
            display: flex !important; 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            font-size: 1.5rem; 
            color: var(--primary); 
            z-index: 1002; 
            cursor: pointer;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .grid-4 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr; }
    }
    .menu-toggle { display: none; }
  </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div id="loaderOverlay">
    <div class="spinner"></div>
    <p style="color:var(--text-dark); margin-top:15px; font-weight:bold;" id="loaderText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    <div class="progress-container hidden" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width:0%">0%</div>
        </div>
    </div>
</div>

<div class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>

<!-- Modals -->
<div id="editWorkerModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h3>
    <input type="hidden" id="editWId">
    <div class="flex-row" style="background:var(--bg-main); padding:15px; border-radius:12px; margin-bottom:25px; justify-content:space-between; border:1px solid var(--border-color);">
        <div>
            <label style="margin:0;">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <small style="color:var(--text-light);">ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ø¹Ù…Ù„</small>
        </div>
        <label style="cursor:pointer; display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="editWActive" style="width:24px; height:24px; accent-color:var(--green);"> 
            <span id="activeStatusText" class="badge bg-green">Ù†Ø´Ø·</span>
        </label>
    </div>
    <div class="grid-2">
        <div><label class="input-label-secondary">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="editWName"></div>
        <div><label class="input-label-secondary">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="editWIqama" readonly style="background:#eee; color:#777;"></div>
    </div>
    <div class="grid-2">
        <div><label class="input-label-secondary">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</label><select id="editWCont"></select></div>
        <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><select id="editWSite"></select></div>
    </div>
    <div><label class="input-label-secondary">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><select id="editWSuper"></select></div>
    <div class="grid-2">
        <div><label class="input-label-secondary">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹</label><select id="editWType"><option value="salary">Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ</option><option value="daily">ÙŠÙˆÙ…ÙŠØ©</option></select></div>
        <div><label class="input-label-secondary">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label><input type="number" id="editWAmt"></div>
    </div>
    <div class="flex-row" style="margin-top:20px;">
        <button onclick="saveWorkerEdit()" class="btn btn-green">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <button onclick="closeModal('editWorkerModal')" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="editUserModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
    <input type="hidden" id="editUId">
    <div class="grid-2">
        <div><label class="input-label-secondary">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="editUFull"></div>
        <div><label class="input-label-secondary">Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</label><input type="text" id="editUName" readonly style="background:#eee;"></div>
    </div>
    <div class="grid-2">
        <div><label class="input-label-secondary">Ø§Ù„Ø¯ÙˆØ±</label><select id="editURole">
            <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
            <option value="hr">Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©</option>
            <option value="supervisor">Ù…Ø´Ø±Ù Ù…ÙˆÙ‚Ø¹</option>
            <option value="data_entry">Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</option>
        </select></div>
        <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ctrl+Click)</label><select id="editUSites" multiple style="height:100px;"></select></div>
    </div>
    <div class="flex-row" style="margin-top:20px;">
        <button onclick="saveUserEdit()" class="btn btn-green">Ø­ÙØ¸</button>
        <button onclick="closeModal('editUserModal')" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="changePassModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <input type="hidden" id="passUId">
    <div><label class="input-label-secondary">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><input type="password" id="newPassword"></div>
    <div><label class="input-label-secondary">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="confirmPassword"></div>
    <div class="flex-row" style="margin-top:20px;">
        <button onclick="savePasswordChange()" class="btn btn-green">Ø­ÙØ¸</button>
        <button onclick="closeModal('changePassModal')" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="editAttendanceModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
    <input type="hidden" id="editAttId">
    <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆØ¸Ù</label><input type="text" id="editAttWorker" readonly style="background:#eee;"></div>
    <div><label class="input-label-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="editAttDate" readonly style="background:#eee;"></div>
    <div><label class="input-label-secondary">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="editAttStatus">
        <option value="present">Ø­Ø§Ø¶Ø±</option>
        <option value="absent">ØºØ§Ø¦Ø¨</option>
        <option value="half">Ù†ØµÙ ÙŠÙˆÙ…</option>
    </select></div>
    <div class="flex-row" style="margin-top:20px;">
        <button onclick="saveAttendanceEdit()" class="btn btn-green">Ø­ÙØ¸</button>
        <button onclick="closeModal('editAttendanceModal')" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Bulk Attendance Modal -->
<div id="bulkAttendanceModal" class="modal-overlay">
  <div class="modal-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
    <p style="color:var(--text-light); margin-bottom:20px;">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span id="bulkCount" style="font-weight:bold; color:var(--primary);">0</span> Ù…ÙˆØ¸Ù</p>
    <div><label class="input-label-secondary">Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</label><select id="bulkStatus">
        <option value="present">Ø­Ø§Ø¶Ø±</option>
        <option value="absent">ØºØ§Ø¦Ø¨</option>
        <option value="half">Ù†ØµÙ ÙŠÙˆÙ…</option>
    </select></div>
    <div class="flex-row" style="margin-top:20px;">
        <button onclick="submitBulkAttendance()" class="btn btn-green">ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
        <button onclick="closeModal('bulkAttendanceModal')" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Login -->
<div id="loginScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-main); z-index:5000; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <div class="card" style="width:90%; max-width:400px; text-align:center; padding:40px;">
        <img src="https://abn.sa.com/wp-content/uploads/2022/01/logo-removebg-preview.png" width="100" style="margin-bottom:25px; filter: grayscale(100%) brightness(0);">
        <h2 style="color:var(--text-dark); margin-bottom:30px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div style="text-align:right;"><label class="input-label-secondary">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="uName"></div>
        <div style="text-align:right;"><label class="input-label-secondary">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="uPass"></div>
        <button onclick="login()" class="btn btn-gold">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        <p id="loginMsg" style="color:var(--red); margin-top:15px;"></p>
    </div>
</div>

<!-- Main App -->
<div id="appLayout" class="hidden" style="display:flex; width:100%;">
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="https://abn.sa.com/wp-content/uploads/2022/01/logo-removebg-preview.png">
        <h4 style="color:white; margin:15px 0 5px 0;" id="sidebarUser"></h4>
        <small style="color:#aaa;" id="sidebarRole"></small>
    </div>
    
    <button onclick="nav('dashboard')" id="n-dashboard" class="nav-btn hidden"><i class="fa-solid fa-gauge-high"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button onclick="nav('workers')" id="n-workers" class="nav-btn hidden"><i class="fa-solid fa-users"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
    <button onclick="nav('sites')" id="n-sites" class="nav-btn hidden"><i class="fa-solid fa-map-location-dot"></i> Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
    <button onclick="nav('contractors')" id="n-contractors" class="nav-btn hidden"><i class="fa-solid fa-handshake"></i> Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</button>
    <button onclick="nav('attendance')" id="n-attendance" class="nav-btn hidden"><i class="fa-solid fa-clipboard-user"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button onclick="nav('approval')" id="n-approval" class="nav-btn hidden"><i class="fa-solid fa-clipboard-check"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button onclick="nav('reports')" id="n-reports" class="nav-btn hidden"><i class="fa-solid fa-chart-pie"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="nav('corrections')" id="n-corrections" class="nav-btn hidden"><i class="fa-solid fa-pen-to-square"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    <button onclick="nav('users')" id="n-users" class="nav-btn hidden"><i class="fa-solid fa-user-shield"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    <button onclick="nav('roles')" id="n-roles" class="nav-btn hidden"><i class="fa-solid fa-key"></i> Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
    
    <div style="flex:1;"></div>
    <button onclick="location.reload()" class="nav-btn" style="color:#ff6b6b;"><i class="fa-solid fa-arrow-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="main-content" onclick="document.getElementById('sidebar').classList.remove('active')">
    
    <div class="page-header">
        <div>
            <h2 id="pageTitle" style="margin:0; color:var(--text-dark);"></h2>
            <div class="breadcrumb">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© > <span id="breadcrumbCurrent"></span></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="v-dashboard" class="view-section hidden">
        <div class="grid-4" style="margin-bottom:25px;">
            <div class="stat-card">
                <i class="fa-solid fa-building" style="color:var(--blue);"></i>
                <div class="number" id="dashSites">0</div>
                <div class="label">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-users" style="color:var(--green);"></i>
                <div class="number" id="dashWorkers">0</div>
                <div class="label">Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-handshake" style="color:var(--orange);"></i>
                <div class="number" id="dashConts">0</div>
                <div class="label">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</div>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-clipboard-check" style="color:var(--primary);"></i>
                <div class="number" id="dashTodayAtt">0</div>
                <div class="label">Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="card">
                <h4 style="margin-top:0;"><i class="fa-solid fa-clock-rotate-left"></i> Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¶Ø§ÙÙŠÙ†</h4>
                <div id="dashRecentWorkers"></div>
            </div>
            <div class="card">
                <h4 style="margin-top:0;"><i class="fa-solid fa-bell"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
                <div id="dashPendingCorrections"></div>
            </div>
        </div>
    </div>

    <!-- WORKERS -->
    <div id="v-workers" class="view-section hidden">
       <div class="sub-tabs">
          <div class="sub-tab active" onclick="switchTab('list')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div class="sub-tab" onclick="switchTab('add')">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</div>
       </div>

       <div id="hr-list-view" class="card" style="border-radius:0 0 12px 12px;">
             <div class="grid-3" style="margin-bottom:20px;">
                 <div><label class="input-label-secondary">Ø¨Ø­Ø«</label><input type="text" id="searchW" onkeyup="renderWorkers()" placeholder="Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©..."></div>
                 <div><label class="input-label-secondary">ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="filtSite" onchange="renderWorkers()"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option></select></div>
                 <div><label class="input-label-secondary">ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</label><select id="filtCont" onchange="renderWorkers()"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option></select></div>
             </div>
             <div class="flex-row" style="justify-content:space-between; margin-bottom:15px;">
                 <label style="cursor:pointer; color:var(--text-light); display:flex; align-items:center; gap:8px;"><input type="checkbox" id="showInactiveW" onchange="renderWorkers()" style="width:auto; margin:0;"> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚ÙˆÙÙŠÙ†</label>
                 <button onclick="loadWorkersFull(true)" class="btn btn-sm btn-outline"><i class="fa-solid fa-sync"></i> ØªØ­Ø¯ÙŠØ«</button>
             </div>
             <div id="workersList"></div>
             <div id="workersLoadMore"></div>
       </div>

       <div id="hr-add-view" class="hidden">
          <div class="card">
             <h3 style="margin-top:0;">ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
             
             <div style="background:var(--bg-main); padding:20px; border-radius:12px; margin-bottom:25px; border:2px dashed var(--border-color); text-align:center;">
                 <h4 style="margin:0 0 10px 0;">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h4>
                 <p style="color:var(--text-light); font-size:0.9rem; margin-bottom:15px;">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ | Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© | Ø§Ù„Ù…Ø³Ù…Ù‰ | Ø§Ù„Ø±Ø§ØªØ¨ | Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ | Ø§Ù„Ù…ÙˆÙ‚Ø¹ | Ø§Ù„Ù…Ø´Ø±Ù | Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</p>
                 <div class="flex-row" style="justify-content:center;">
                     <button onclick="document.getElementById('excelFile').click()" class="btn btn-sm btn-gold" style="width:auto;"><i class="fa-solid fa-upload"></i> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</button>
                     <button onclick="downloadTemplate()" class="btn btn-sm btn-outline" style="width:auto;"><i class="fa-solid fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
                 </div>
                 <input type="file" id="excelFile" accept=".xlsx, .xls" style="display:none" onchange="handleExcelUpload(this)">
             </div>

             <h4>Ø£Ùˆ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ:</h4>
             <div class="grid-2">
                 <div><label class="input-label-secondary">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label><input type="text" id="newWName"></div>
                 <div><label class="input-label-secondary">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label><input type="text" id="newWIqama"></div>
             </div>
             <div class="grid-3">
                 <div><label class="input-label-secondary">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡</label><select id="newWCont"><option value="">Ø§Ø®ØªØ±...</option></select></div>
                 <div><label class="input-label-secondary">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</label><select id="newWSite"><option value="">Ø§Ø®ØªØ±...</option></select></div>
                 <div><label class="input-label-secondary">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</label><select id="newWSuper"><option value="">Ø§Ø®ØªØ±...</option></select></div>
             </div>
             <div class="grid-2">
                 <div><label class="input-label-secondary">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹</label><select id="newWType"><option value="salary">Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ</option><option value="daily">ÙŠÙˆÙ…ÙŠØ©</option></select></div>
                 <div><label class="input-label-secondary">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</label><input type="number" id="newWAmt"></div>
             </div>
             <button onclick="addWorker()" class="btn btn-gold" style="max-width:200px; margin-top:20px;">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
          </div>
       </div>
    </div>

    <!-- SITES -->
    <div id="v-sites" class="view-section hidden">
       <div class="card">
          <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
          <div class="flex-row">
             <div style="flex:1"><label class="input-label-secondary">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><input type="text" id="nSite" style="margin:0;"></div>
             <div style="flex:1"><label class="input-label-secondary">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label><select id="nSiteCont" style="margin:0;"><option value="">Ø§Ø®ØªØ±...</option></select></div>
             <button onclick="addSite()" class="btn btn-gold" style="width:auto; align-self:flex-end; padding:12px 25px;">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
       </div>
       <div id="sitesList" class="grid-3"></div>
    </div>

    <!-- CONTRACTORS -->
    <div id="v-contractors" class="view-section hidden">
        <div class="card">
            <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="flex-row">
                <div style="flex:1"><label class="input-label-secondary">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ / Ø§Ù„Ø´Ø±ÙƒØ©</label><input type="text" id="nCont" style="margin:0;"></div>
                <button onclick="addCont()" class="btn btn-gold" style="width:auto; align-self:flex-end; padding:12px 25px;">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
        </div>
        <div id="contsList" class="grid-3"></div>
    </div>

    <!-- ATTENDANCE (Supervisor) - Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© -->
    <div id="v-attendance" class="view-section hidden">
       <div class="sub-tabs">
          <div class="sub-tab active" onclick="switchAttTab('register')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</div>
          <div class="sub-tab" onclick="switchAttTab('review')">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø³Ø¬Ù„</div>
       </div>
       
       <div id="att-register-view" class="card">
          <div class="grid-3" style="margin-bottom:20px;">
              <div><label class="input-label-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="attDate" onchange="loadAttendanceRegister()"></div>
              <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="attSite" onchange="loadAttendanceRegister()"></select></div>
          </div>
          
          <!-- Counter Bar -->
          <div class="counter-bar" id="attCounterBar">
              <div class="counter-item">
                  <div class="number" id="countTotal">0</div>
                  <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ø§Ù„</div>
              </div>
              <div class="counter-item">
                  <div class="number" id="countPending">0</div>
                  <div class="label">Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ØªØ³Ø¬ÙŠÙ„</div>
              </div>
              <div class="counter-item">
                  <div class="number" id="countPresent">0</div>
                  <div class="label" style="color:var(--green)">Ø­Ø§Ø¶Ø±</div>
              </div>
              <div class="counter-item">
                  <div class="number" id="countAbsent">0</div>
                  <div class="label" style="color:var(--red)">ØºØ§Ø¦Ø¨</div>
              </div>
              <div class="counter-item">
                  <div class="number" id="countHalf">0</div>
                  <div class="label" style="color:var(--orange)">Ù†ØµÙ ÙŠÙˆÙ…</div>
              </div>
          </div>
          
          <!-- Bulk Actions -->
          <div class="flex-row" style="margin-bottom:15px; background:var(--bg-main); padding:15px; border-radius:8px;">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:bold;">
                  <input type="checkbox" id="selectAllAtt" onchange="toggleSelectAllAtt()" class="custom-checkbox">
                  ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ (<span id="selectAllCount">0</span>)
              </label>
              <div class="flex-row" style="margin-right:auto;">
                  <span id="selectedCount" style="color:var(--text-light);">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± 0</span>
                  <button onclick="openBulkAttendance()" class="btn btn-sm btn-green" id="bulkActionBtn" disabled>
                      <i class="fa-solid fa-users"></i> ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
                  </button>
              </div>
          </div>
          
          <div id="attendanceRegisterList"></div>
       </div>
       
       <div id="att-review-view" class="hidden card">
          <div class="grid-3" style="margin-bottom:20px;">
              <div><label class="input-label-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="reviewDate" onchange="loadAttendanceReview()"></div>
              <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="reviewSite" onchange="loadAttendanceReview()"></select></div>
          </div>
          <div id="attendanceReviewList"></div>
       </div>
    </div>

    <!-- APPROVAL (Data Entry) -->
    <div id="v-approval" class="view-section hidden">
       <div class="sub-tabs">
          <div class="sub-tab active" onclick="switchAppTab('pending')">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù‚</div>
          <div class="sub-tab" onclick="switchAppTab('approved')">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</div>
       </div>
       
       <div id="app-pending-view" class="card">
          <div class="grid-3" style="margin-bottom:20px;">
              <div><label class="input-label-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="appDate" onchange="loadPendingApproval()"></div>
              <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="appSite" onchange="loadPendingApproval()"></select></div>
          </div>
          <div class="flex-row" style="margin-bottom:15px;">
              <label style="cursor:pointer; display:flex; align-items:center; gap:8px;"><input type="checkbox" id="selectAllPending" onchange="toggleSelectAll()" style="width:auto;"> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„</label>
              <div class="flex-row">
                  <button onclick="bulkApprove('approve')" class="btn btn-sm btn-green">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                  <button onclick="bulkApprove('reject')" class="btn btn-sm btn-red">Ø±ÙØ¶ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
                  <button onclick="bulkApprove('delete')" class="btn btn-sm btn-gray">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
              </div>
          </div>
          <div id="pendingApprovalList"></div>
       </div>
       
       <div id="app-approved-view" class="hidden card">
          <div class="grid-3" style="margin-bottom:20px;">
              <div><label class="input-label-secondary">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="appApprovedDate" onchange="loadApprovedAttendance()"></div>
              <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="appApprovedSite" onchange="loadApprovedAttendance()"></select></div>
          </div>
          <div id="approvedAttendanceList"></div>
       </div>
    </div>

    <!-- REPORTS -->
    <div id="v-reports" class="view-section hidden">
      <div class="card" style="max-width:800px; margin:0 auto;">
        <h3>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
        <div class="grid-2">
            <div><label class="input-label-secondary">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <select id="repType" onchange="updateReportOptions()">
               <option value="payroll">ğŸ’° Ù…Ø³ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨ (ØªÙØµÙŠÙ„ÙŠ)</option>
               <option value="contractor_invoice">ğŸ§¾ Ù…Ø³ØªØ®Ù„Øµ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>
               <option value="attendance_log">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</option>
               <option value="workers">ğŸ‘· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
            </select></div>
        </div>
        <div class="grid-2" id="repDateRange">
            <div><label class="input-label-secondary">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="repStart"></div>
            <div><label class="input-label-secondary">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="repEnd"></div>
        </div>
        <div class="grid-2">
            <div><label class="input-label-secondary">ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><select id="repSite"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option></select></div>
            <div><label class="input-label-secondary">ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</label><select id="repCont"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option></select></div>
        </div>
        <button onclick="genReport()" class="btn btn-gold" style="margin-top:20px;"><i class="fa-solid fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
      </div>
    </div>

    <!-- CORRECTIONS -->
    <div id="v-corrections" class="view-section hidden">
       <div class="card">
           <h3>Ø·Ù„Ø¨Ø§Øª ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h3>
           <div id="correctionsList"></div>
       </div>
    </div>

    <!-- USERS -->
    <div id="v-users" class="view-section hidden">
       <div class="card" style="max-width:800px; margin:0 auto;">
           <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
           <div class="grid-2">
               <div><label class="input-label-secondary">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="nUFull"></div>
               <div><label class="input-label-secondary">Ø§Ù„Ø¯ÙˆØ±</label><select id="nURole">
                   <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
                   <option value="hr">Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©</option>
                   <option value="supervisor">Ù…Ø´Ø±Ù Ù…ÙˆÙ‚Ø¹</option>
                   <option value="data_entry">Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</option>
               </select></div>
           </div>
           <div class="grid-2">
               <div><label class="input-label-secondary">Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</label><input type="text" id="nUName"></div>
               <div><label class="input-label-secondary">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="nUPass"></div>
           </div>
           <div><label class="input-label-secondary">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (Ctrl+Click Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯)</label><select id="nUSites" multiple style="height:100px;"></select></div>
           <button onclick="addUser()" class="btn btn-gold" style="max-width:200px; margin-top:10px;">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…</button>
       </div>
       <div id="usersList" style="max-width:800px; margin:25px auto 0 auto;"></div>
    </div>
    
    <!-- ROLES - Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© -->
    <div id="v-roles" class="view-section hidden">
       <div class="card">
           <h3><i class="fa-solid fa-shield-halved"></i> Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
           <p style="color:var(--text-light); margin-bottom:20px;">Ø¬Ø¯ÙˆÙ„ ÙŠÙˆØ¶Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ„ Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
           
           <div style="overflow-x:auto;">
               <table class="roles-table">
                   <thead>
                       <tr>
                           <th>Ø§Ù„Ø¯ÙˆØ±</th>
                           <th>Ø§Ù„ÙˆØµÙ</th>
                           <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</th>
                           <th>Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±</th>
                       </tr>
                   </thead>
                   <tbody>
                       <tr>
                           <td><span class="badge bg-blue" style="font-size:1rem;"><i class="fa-solid fa-crown"></i> Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</span></td>
                           <td>ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</td>
                           <td>
                               â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)<br>
                               â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†<br>
                               â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª<br>
                               â€¢ Ø§Ø¹ØªÙ…Ø§Ø¯/Ø±ÙØ¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„<br>
                               â€¢ ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±
                           </td>
                           <td>Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (4 ØªÙ‚Ø§Ø±ÙŠØ±)</td>
                       </tr>
                       <tr>
                           <td><span class="badge bg-green" style="font-size:1rem;"><i class="fa-solid fa-user-tie"></i> Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©</span></td>
                           <td>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</td>
                           <td>
                               â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù)<br>
                               â€¢ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§Ù‚Ø¹ Ø¬Ø¯ÙŠØ¯Ø©<br>
                               â€¢ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„<br>
                               â€¢ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
                           </td>
                           <td>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙ‚Ø·</td>
                       </tr>
                       <tr>
                           <td><span class="badge bg-orange" style="font-size:1rem;"><i class="fa-solid fa-hard-hat"></i> Ù…Ø´Ø±Ù Ù…ÙˆÙ‚Ø¹</span></td>
                           <td>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹</td>
                           <td>
                               â€¢ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø¹Ù…Ø§Ù„ (Ø­Ø§Ø¶Ø±/ØºØ§Ø¦Ø¨/Ù†ØµÙ ÙŠÙˆÙ…)<br>
                               â€¢ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø³Ø¬Ù„<br>
                               â€¢ ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹
                           </td>
                           <td>Ù„Ø§ ÙŠÙˆØ¬Ø¯</td>
                       </tr>
                       <tr>
                           <td><span class="badge bg-gray" style="font-size:1rem;"><i class="fa-solid fa-keyboard"></i> Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª</span></td>
                           <td>Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø³Ø¬Ù„</td>
                           <td>
                               â€¢ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù‚<br>
                               â€¢ Ø±ÙØ¶/Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±<br>
                               â€¢ Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯
                           </td>
                           <td>Ù„Ø§ ÙŠÙˆØ¬Ø¯</td>
                       </tr>
                   </tbody>
               </table>
           </div>
           
           <div class="card" style="margin-top:20px; background:var(--bg-main);">
               <h4 style="margin-top:0;"><i class="fa-solid fa-lightbulb"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©</h4>
               <ul style="line-height:2; color:var(--text-dark);">
                   <li>ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ Ø£Ùˆ Ø£ÙƒØ«Ø± Ø­Ø³Ø¨ Ø·Ø¨ÙŠØ¹Ø© Ø¹Ù…Ù„Ù‡</li>
                   <li>Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ±Ù‰ ÙÙ‚Ø· Ø¹Ù…Ø§Ù„ Ù…ÙˆÙ‚Ø¹Ù‡/Ù…ÙˆØ§Ù‚Ø¹Ù‡ Ø§Ù„Ù…Ø®ØµØµØ©</li>
                   <li>Ù…Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ±Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ù…ÙˆØ§Ù‚Ø¹Ù‡ ÙÙ‚Ø·</li>
                   <li>Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡ (Ø¹Ø¨Ø± Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</li>
                   <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ (Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¹Ù…Ù„ ÙˆÙ…ØªÙ‰)</li>
               </ul>
           </div>
       </div>
    </div>

  </div>
</div>

<script>
  // Supabase
  const UP_URL = 'https://aouflbxavabmochmmigg.supabase.co';
  const UP_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdWZsYnhhdmFibW9jaG1taWdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzEwNzcsImV4cCI6MjA4NDg0NzA3N30.7JxbYBTcdxHILfI0uThuE3zxJLQXG8peSQKEX3d35e4';
  const sb = window.supabase.createClient(UP_URL, UP_KEY);

  let CUR_USER = null, ALL_WORKERS = [], SITES_CACHE = [], CONTS_CACHE = [], USERS_CACHE = [];
  let WORKERS_PAGE = 0;
  const WORKERS_PER_PAGE = 100;
  let ALL_WORKERS_LOADED = false;
  let SELECTED_WORKERS = new Set();

  // Toast
  function showToast(msg, type='success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = type === 'error' ? 'fa-circle-xmark' : type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-check';
      toast.innerHTML = `<i class="fa-solid ${icon}" style="color:var(--${type==='error'?'red':type==='warning'?'orange':'green'})"></i><span>${msg}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
  }

  function showLoad(s, text='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
      document.getElementById('loaderOverlay').style.display = s ? 'flex' : 'none';
      document.getElementById('loaderText').innerText = text;
  }
  
  function showProgress(percent, text) {
      document.getElementById('progressContainer').classList.remove('hidden');
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressFill').innerText = percent + '%';
      if(text) document.getElementById('loaderText').innerText = text;
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  
  function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
  }
  
  function nav(v) {
      document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden'));
      document.getElementById('v-'+v).classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
      const btn = document.getElementById('n-'+v);
      if(btn) btn.classList.add('active');
      document.getElementById('pageTitle').innerText = btn ? btn.innerText.trim() : '';
      document.getElementById('breadcrumbCurrent').innerText = btn ? btn.innerText.trim() : '';
      
      if(v === 'dashboard') loadDashboard();
      if(v === 'attendance') { initAttendanceFilters(); loadAttendanceRegister(); }
      if(v === 'approval') { initApprovalFilters(); loadPendingApproval(); }
      if(v === 'corrections') loadCorrections();
      if(v === 'roles') loadRoles();
  }

  // Login
  async function login() {
      const u=document.getElementById('uName').value, p=document.getElementById('uPass').value;
      if(!u || !p) return showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
      showLoad(true);
      
      const {data, error} = await sb.from('app_users').select('*, user_sites(site_id)').eq('username',u).single();
      showLoad(false);
      
      if(error || !data || data.password !== p) {
          showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
          return;
      }
      
      CUR_USER = data;
      CUR_USER.sites = data.user_sites ? data.user_sites.map(us => us.site_id) : [];
      
      document.getElementById('loginScreen').style.display='none';
      document.getElementById('appLayout').classList.remove('hidden');
      document.getElementById('sidebarUser').innerText = data.full_name;
      document.getElementById('sidebarRole').innerText = getRoleName(data.role);
      
      setupPermissions();
      loadData();
  }

  function getRoleName(r) { 
      const names = {admin:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', hr:'Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©', supervisor:'Ù…Ø´Ø±Ù Ù…ÙˆÙ‚Ø¹', data_entry:'Ù…Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª'};
      return names[r] || r;
  }

  function setupPermissions() {
      const r = CUR_USER.role;
      const isAdmin = r === 'admin';
      const isHR = r === 'hr';
      
      if(isAdmin) {
          ['dashboard','workers','sites','contractors','attendance','approval','reports','corrections','users','roles'].forEach(id => {
              document.getElementById('n-'+id)?.classList.remove('hidden');
          });
          nav('dashboard');
      } else if(isHR) {
          ['workers','sites','reports'].forEach(id => document.getElementById('n-'+id)?.classList.remove('hidden'));
          const repType = document.getElementById('repType');
          repType.innerHTML = `
              <option value="attendance_log">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</option>
              <option value="workers">ğŸ‘· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
          `;
          nav('workers');
      } else if(r === 'supervisor') {
          document.getElementById('n-attendance')?.classList.remove('hidden');
          nav('attendance');
      } else if(r === 'data_entry') {
          document.getElementById('n-approval')?.classList.remove('hidden');
          nav('approval');
      }
  }

  async function loadData() {
      showLoad(true);
      await Promise.all([loadSites(), loadConts()]);
      if(CUR_USER.role === 'admin' || CUR_USER.role === 'hr') loadWorkersFull(true);
      if(CUR_USER.role === 'admin') loadUsers();
      showLoad(false);
  }

  // Sites
  async function loadSites() {
      const {data} = await sb.from('sites').select('*, contractors(name)').order('name');
      SITES_CACHE = data || [];
      
      const opts = '<option value="">Ø§Ø®ØªØ±...</option>' + SITES_CACHE.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      const allOpts = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>' + SITES_CACHE.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      
      ['newWSite','editWSite','nSiteCont','attSite','reviewSite','appSite','appApprovedSite','repSite'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.innerHTML = id.includes('filt') || id.includes('rep') || id.includes('app') || id.includes('review') || id.includes('att') ? allOpts : opts;
      });
      
      const userSites = CUR_USER.role === 'admin' ? SITES_CACHE : SITES_CACHE.filter(s => CUR_USER.sites.includes(s.id));
      
      document.getElementById('sitesList').innerHTML = userSites.map(s=>`
        <div class="card ${s.is_active===false?'inactive-card':''}" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
            <div>
                <b style="font-size:1.1rem;">${s.name}</b><br>
                <small style="color:var(--text-light)">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„: ${s.contractors?.name||'-'}</small>
            </div>
            <div class="flex-row">
                <label class="toggle-switch" title="${s.is_active!==false?'Ø¥ÙŠÙ‚Ø§Ù':'ØªÙØ¹ÙŠÙ„'}">
                    <input type="checkbox" ${s.is_active!==false?'checked':''} onchange="toggleSiteActive(${s.id}, this.checked)">
                    <span class="slider"></span>
                </label>
                <button onclick="delSite(${s.id})" class="btn-sm btn-red"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`).join('');
  }

  async function addSite() {
      const n=document.getElementById('nSite').value, c=document.getElementById('nSiteCont').value;
      if(!n) return showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
      showLoad(true);
      await sb.from('sites').insert({name:n, main_contractor_id:c||null, is_active:true});
      document.getElementById('nSite').value='';
      await loadSites();
      showLoad(false);
      showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
  }

  async function toggleSiteActive(id, active) {
      showLoad(true);
      await sb.from('sites').update({is_active:active}).eq('id',id);
      await loadSites();
      showLoad(false);
      showToast(active ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹');
  }

  async function delSite(id) {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      showLoad(true);
      await sb.from('sites').delete().eq('id',id);
      await loadSites();
      showLoad(false);
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹');
  }

  // Contractors
  async function loadConts() {
      const {data} = await sb.from('contractors').select('*').order('name');
      CONTS_CACHE = data || [];
      
      const opts = '<option value="">Ø§Ø®ØªØ±...</option>' + CONTS_CACHE.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      const allOpts = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>' + CONTS_CACHE.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      
      ['newWCont','editWCont','repCont','filtCont','nSiteCont'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.innerHTML = id.includes('filt') || id.includes('rep') ? allOpts : opts;
      });
      
      document.getElementById('contsList').innerHTML = CONTS_CACHE.map(c=>`
        <div class="card ${c.is_active===false?'inactive-card':''}" style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
            <b>${c.name}</b>
            <div class="flex-row">
                <label class="toggle-switch">
                    <input type="checkbox" ${c.is_active!==false?'checked':''} onchange="toggleContActive(${c.id}, this.checked)">
                    <span class="slider"></span>
                </label>
                <button onclick="delCont(${c.id})" class="btn-sm btn-red"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>`).join('');
  }

  async function addCont() {
      const n=document.getElementById('nCont').value;
      if(!n) return showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„', 'error');
      showLoad(true);
      await sb.from('contractors').insert({name:n, is_active:true});
      document.getElementById('nCont').value='';
      await loadConts();
      showLoad(false);
      showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');
  }

  async function toggleContActive(id, active) {
      showLoad(true);
      await sb.from('contractors').update({is_active:active}).eq('id',id);
      await loadConts();
      showLoad(false);
      showToast(active ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„');
  }

  async function delCont(id) {
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      showLoad(true);
      await sb.from('contractors').delete().eq('id',id);
      await loadConts();
      showLoad(false);
  }

  // Workers with Pagination
  function switchTab(t) {
      document.getElementById('hr-add-view').classList.toggle('hidden', t!='add');
      document.getElementById('hr-list-view').classList.toggle('hidden', t!='list');
      document.querySelectorAll('#v-workers .sub-tab').forEach((e,i)=>e.classList.toggle('active', (t=='list'&&i==0)||(t=='add'&&i==1)));
      if(t=='list') loadWorkersFull(true);
  }

  async function loadWorkersFull(reset = true) {
      if(reset) {
          WORKERS_PAGE = 0;
          ALL_WORKERS = [];
          ALL_WORKERS_LOADED = false;
          document.getElementById('workersList').innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div></div>';
          document.getElementById('workersLoadMore').innerHTML = '';
      }
      
      if(ALL_WORKERS_LOADED) return;
      
      const from = WORKERS_PAGE * WORKERS_PER_PAGE;
      const to = from + WORKERS_PER_PAGE - 1;
      
      let query = sb.from('workers')
          .select('*, sites(name), contractors(name), supervisors:assigned_supervisor_id(full_name)', {count: 'exact'})
          .eq('is_active', true)
          .order('name')
          .range(from, to);
      
      if(CUR_USER.role !== 'admin') {
          query = query.in('current_site_id', CUR_USER.sites.length > 0 ? CUR_USER.sites : [0]);
      }
      
      const {data, count, error} = await query;
      
      if(error) {
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
          return;
      }
      
      if(data && data.length > 0) {
          ALL_WORKERS = [...ALL_WORKERS, ...data];
          WORKERS_PAGE++;
          if(data.length < WORKERS_PER_PAGE || ALL_WORKERS.length >= (count || 0)) {
              ALL_WORKERS_LOADED = true;
          }
      } else {
          ALL_WORKERS_LOADED = true;
      }
      
      renderWorkers();
      
      if(!ALL_WORKERS_LOADED) {
          document.getElementById('workersLoadMore').innerHTML = `
              <button onclick="loadWorkersFull(false)" class="btn btn-outline" style="margin-top:20px;">
                  ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ (${ALL_WORKERS.length} Ù…Ù† ${count || 'ØŸ'})
              </button>`;
      }
      
      if(reset) {
          const {data:supers} = await sb.from('app_users').select('*').eq('role','supervisor').limit(1000);
          const opts = '<option value="">Ø§Ø®ØªØ±...</option>' + (supers||[]).map(s=>`<option value="${s.id}">${s.full_name}</option>`).join('');
          ['newWSuper','editWSuper'].forEach(id => {
              const el = document.getElementById(id);
              if(el) el.innerHTML = opts;
          });
      }
  }

  function renderWorkers() {
      const q = document.getElementById('searchW').value.toLowerCase().trim();
      const s = document.getElementById('filtSite').value;
      const c = document.getElementById('filtCont').value;
      const showIn = document.getElementById('showInactiveW').checked;
      
      let res = ALL_WORKERS.filter(w => {
          const matchName = !q || w.name.toLowerCase().includes(q) || w.id_number.includes(q);
          const matchSite = !s || w.current_site_id == s;
          const matchCont = !c || w.contractor_id == c;
          const matchActive = showIn ? true : (w.is_active !== false);
          return matchName && matchSite && matchCont && matchActive;
      });
      
      if(q && res.length < 10 && !ALL_WORKERS_LOADED) {
          loadWorkersFull(false);
      }
      
      document.getElementById('workersList').innerHTML = res.map(w => `
      <div class="card ${w.is_active===false?'inactive-card':''}" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:15px;">
          <div style="display:flex; align-items:center; gap:15px;">
              <div style="width:50px; height:50px; background:#eee; border-radius:50%; display:flex; justify-content:center; align-items:center; font-weight:bold; color:#777; font-size:1.2rem;">
                  ${w.name.charAt(0)}
              </div>
              <div>
                  <b style="font-size:1.1rem;">${w.name}</b>
                  ${w.is_active===false?'<span class="badge bg-gray" style="margin-right:5px;">Ù…ÙˆÙ‚ÙˆÙ</span>':''}
                  <br>
                  <small style="color:var(--text-light);">
                      <i class="fa-solid fa-id-card"></i> ${w.id_number} | 
                      <i class="fa-solid fa-map-pin"></i> ${w.sites?.name||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                  </small>
              </div>
          </div>
          <div class="flex-row">
              <label class="toggle-switch">
                  <input type="checkbox" ${w.is_active!==false?'checked':''} onchange="toggleWorkerActive(${w.id}, this.checked)">
                  <span class="slider"></span>
              </label>
              <button onclick="openEditW(${w.id})" class="btn-sm btn-outline"><i class="fa-solid fa-pen"></i></button>
              ${CUR_USER.role === 'admin' ? `<button onclick="delWorker(${w.id})" class="btn-sm btn-red"><i class="fa-solid fa-trash"></i></button>` : ''}
          </div>
      </div>`).join('') || '<p style="text-align:center; color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
  }

  async function toggleWorkerActive(id, active) {
      showLoad(true);
      await sb.from('workers').update({is_active:active}).eq('id',id);
      await loadWorkersFull(true);
      showLoad(false);
      showToast(active ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ¸Ù');
  }

  async function addWorker() {
      const idNum = document.getElementById('newWIqama').value.trim();
      const d = {
          id_number: idNum,
          name: document.getElementById('newWName').value,
          contractor_id: document.getElementById('newWCont').value || null,
          current_site_id: document.getElementById('newWSite').value || null,
          assigned_supervisor_id: document.getElementById('newWSuper').value || null,
          payment_type: document.getElementById('newWType').value,
          basic_salary: document.getElementById('newWAmt').value,
          is_active: true
      };
      
      if(!d.name || !d.id_number) return showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', 'error');
      
      const {data:existing} = await sb.from('workers').select('id').eq('id_number',idNum).single();
      if(existing) return showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'error');
      
      showLoad(true);
      const {error} = await sb.from('workers').insert(d);
      showLoad(false);
      
      if(error) return showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', 'error');
      
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
      document.getElementById('newWIqama').value='';
      document.getElementById('newWName').value='';
      loadWorkersFull(true);
      switchTab('list');
  }

  function openEditW(id) {
      const w = ALL_WORKERS.find(x=>x.id==id);
      document.getElementById('editWId').value=w.id;
      document.getElementById('editWName').value=w.name;
      document.getElementById('editWIqama').value=w.id_number;
      document.getElementById('editWCont').value=w.contractor_id||'';
      document.getElementById('editWSite').value=w.current_site_id||'';
      document.getElementById('editWSuper').value=w.assigned_supervisor_id||'';
      document.getElementById('editWType').value=w.payment_type;
      document.getElementById('editWAmt').value=w.basic_salary;
      
      const chk = document.getElementById('editWActive');
      const txt = document.getElementById('activeStatusText');
      chk.checked = (w.is_active !== false);
      txt.innerText = chk.checked ? 'Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ';
      txt.className = chk.checked ? 'badge bg-green' : 'badge bg-gray';
      
      document.getElementById('editWorkerModal').classList.add('open');
  }

  async function saveWorkerEdit() {
      const id = document.getElementById('editWId').value;
      showLoad(true);
      const {error} = await sb.from('workers').update({
          name: document.getElementById('editWName').value,
          contractor_id: document.getElementById('editWCont').value || null,
          current_site_id: document.getElementById('editWSite').value || null,
          assigned_supervisor_id: document.getElementById('editWSuper').value || null,
          payment_type: document.getElementById('editWType').value,
          basic_salary: document.getElementById('editWAmt').value,
          is_active: document.getElementById('editWActive').checked
      }).eq('id',id);
      showLoad(false);
      if(error) return showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
      closeModal('editWorkerModal');
      loadWorkersFull(true);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
  }

  async function delWorker(id) {
      if(!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
      showLoad(true);
      await sb.from('workers').delete().eq('id',id);
      loadWorkersFull(true);
      showLoad(false);
      showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù');
  }

  // Excel
  function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([
        ["Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©","Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ","Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ (Ø±Ø§ØªØ¨/ÙŠÙˆÙ…ÙŠØ©)","Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹","Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù","Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„"],
        ["Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ","1010101010","Ø¹Ø§Ù…Ù„","2500","Ø±Ø§ØªØ¨","Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶ 1","Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯","Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹Ø¯"]
    ]);
    XLSX.utils.book_append_sheet(wb, ws, "Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    XLSX.writeFile(wb, "Ù†Ù…ÙˆØ°Ø¬_Ø§Ø³ØªÙŠØ±Ø§Ø¯_Ø§Ù„Ø¹Ù…Ø§Ù„.xlsx");
  }

  async function handleExcelUpload(input) {
      const file = input.files[0];
      if(!file) return;
      if(!confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) { input.value=''; return; }
      
      showLoad(true);
      const reader = new FileReader();
      reader.onload = async (e) => {
          try {
              const data = new Uint8Array(e.target.result);
              const wb = XLSX.read(data, {type:'array'});
              const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
              
              let count=0, errors=[];
              
              for(let i=1; i<rows.length; i++) {
                  if(!rows[i][0] || !rows[i][1]) continue;
                  
                  const site = SITES_CACHE.find(s => s.name === rows[i][5]);
                  const cont = CONTS_CACHE.find(c => c.name === rows[i][7]);
                  const {data:supervisor} = await sb.from('app_users').select('id').eq('full_name',rows[i][6]).eq('role','supervisor').single();
                  
                  const {data:existing} = await sb.from('workers').select('id').eq('id_number',String(rows[i][1])).single();
                  if(existing) {
                      errors.push(`Ø§Ù„ØµÙ ${i+1}: ${rows[i][1]} Ù…Ø³Ø¬Ù„`);
                      continue;
                  }
                  
                  await sb.from('workers').insert({
                      name: rows[i][0],
                      id_number: String(rows[i][1]),
                      job_title: rows[i][2],
                      basic_salary: rows[i][3],
                      payment_type: rows[i][4] === 'ÙŠÙˆÙ…ÙŠØ©' ? 'daily' : 'salary',
                      current_site_id: site?.id || null,
                      assigned_supervisor_id: supervisor?.id || null,
                      contractor_id: cont?.id || null,
                      is_active: true
                  });
                  count++;
              }
              
              if(errors.length > 0) showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ù…ÙˆØ¸Ù. Ø£Ø®Ø·Ø§Ø¡: ${errors.length}`, 'warning');
              else showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!`);
              
              loadWorkersFull(true);
              switchTab('list');
          } catch(err) {
              showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
          }
          showLoad(false);
          input.value='';
      };
      reader.readAsArrayBuffer(file);
  }

  // Attendance (Supervisor) - Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  function initAttendanceFilters() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attDate').value = today;
      document.getElementById('reviewDate').value = today;
      
      const userSites = CUR_USER.role === 'admin' ? SITES_CACHE : SITES_CACHE.filter(s => CUR_USER.sites.includes(s.id));
      const opts = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>' + userSites.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      document.getElementById('attSite').innerHTML = opts;
      document.getElementById('reviewSite').innerHTML = opts;
  }

  function switchAttTab(t) {
      document.getElementById('att-register-view').classList.toggle('hidden', t!='register');
      document.getElementById('att-review-view').classList.toggle('hidden', t!='review');
      document.querySelectorAll('#v-attendance .sub-tab').forEach((e,i)=>e.classList.toggle('active', (t=='register'&&i==0)||(t=='review'&&i==1)));
      if(t=='register') loadAttendanceRegister();
      else loadAttendanceReview();
  }

  async function loadAttendanceRegister() {
      const date = document.getElementById('attDate').value;
      const siteId = document.getElementById('attSite').value;
      
      if(!date) return;
      
      showLoad(true);
      SELECTED_WORKERS.clear();
      updateSelectedCount();
      
      // Get all workers (with pagination if needed)
      let allWorkers = [];
      let from = 0;
      const chunk = 1000;
      
      while(true) {
          let query = sb.from('workers').select('*').eq('is_active',true);
          if(siteId) query = query.eq('current_site_id',siteId);
          else if(CUR_USER.role !== 'admin') query = query.in('current_site_id', CUR_USER.sites.length > 0 ? CUR_USER.sites : [0]);
          
          const {data} = await query.range(from, from + chunk - 1);
          if(!data || data.length === 0) break;
          allWorkers.push(...data);
          if(data.length < chunk) break;
          from += chunk;
      }
      
      // Get existing attendance
      let attQuery = sb.from('attendance').select('*').eq('date',date);
      const {data:existingAtt} = await attQuery;
      
      // Calculate stats
      const existingIds = existingAtt ? existingAtt.map(a => a.worker_id) : [];
      const present = existingAtt ? existingAtt.filter(a => a.status === 'present').length : 0;
      const absent = existingAtt ? existingAtt.filter(a => a.status === 'absent').length : 0;
      const half = existingAtt ? existingAtt.filter(a => a.status === 'half').length : 0;
      
      document.getElementById('countTotal').innerText = allWorkers.length;
      document.getElementById('countPending').innerText = allWorkers.length - existingIds.length;
      document.getElementById('countPresent').innerText = present;
      document.getElementById('countAbsent').innerText = absent;
      document.getElementById('countHalf').innerText = half;
      document.getElementById('selectAllCount').innerText = allWorkers.length - existingIds.length;
      
      const pendingWorkers = allWorkers.filter(w => !existingIds.includes(w.id));
      
      document.getElementById('attendanceRegisterList').innerHTML = pendingWorkers.map(w => `
      <div class="card worker-card" id="worker-${w.id}" style="margin-bottom:10px;">
          <input type="checkbox" class="custom-checkbox" value="${w.id}" onchange="toggleWorkerSelection(${w.id})">
          <div style="flex:1;">
              <b>${w.name}</b><br>
              <small style="color:var(--text-light);">${w.id_number}</small>
          </div>
          <div class="flex-row">
              <button onclick="registerAttendance(${w.id},'present')" class="attendance-btn att-present">Ø­Ø§Ø¶Ø±</button>
              <button onclick="registerAttendance(${w.id},'absent')" class="attendance-btn att-absent">ØºØ§Ø¦Ø¨</button>
              <button onclick="registerAttendance(${w.id},'half')" class="attendance-btn att-half">Ù†ØµÙ ÙŠÙˆÙ…</button>
          </div>
      </div>`).join('') || '<div class="card" style="text-align:center; padding:40px; color:var(--text-light);"><i class="fa-solid fa-check-circle fa-3x" style="color:var(--green); margin-bottom:15px;"></i><br>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</div>';
      
      showLoad(false);
  }

  function toggleWorkerSelection(id) {
      const checkbox = document.querySelector(`#worker-${id} input[type="checkbox"]`);
      const card = document.getElementById(`worker-${id}`);
      
      if(checkbox.checked) {
          SELECTED_WORKERS.add(id);
          card.classList.add('selected');
      } else {
          SELECTED_WORKERS.delete(id);
          card.classList.remove('selected');
      }
      updateSelectedCount();
  }

  function toggleSelectAllAtt() {
      const checked = document.getElementById('selectAllAtt').checked;
      const checkboxes = document.querySelectorAll('#attendanceRegisterList input[type="checkbox"]');
      
      checkboxes.forEach(cb => {
          cb.checked = checked;
          const id = parseInt(cb.value);
          const card = document.getElementById(`worker-${id}`);
          if(checked) {
              SELECTED_WORKERS.add(id);
              card?.classList.add('selected');
          } else {
              SELECTED_WORKERS.delete(id);
              card?.classList.remove('selected');
          }
      });
      updateSelectedCount();
  }

  function updateSelectedCount() {
      const count = SELECTED_WORKERS.size;
      document.getElementById('selectedCount').innerText = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${count}`;
      document.getElementById('bulkActionBtn').disabled = count === 0;
  }

  function openBulkAttendance() {
      document.getElementById('bulkCount').innerText = SELECTED_WORKERS.size;
      document.getElementById('bulkAttendanceModal').classList.add('open');
  }

  async function submitBulkAttendance() {
      const status = document.getElementById('bulkStatus').value;
      const date = document.getElementById('attDate').value;
      const siteId = document.getElementById('attSite').value;
      const workers = Array.from(SELECTED_WORKERS);
      
      closeModal('bulkAttendanceModal');
      showLoad(true, `Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ ${workers.length} Ù…ÙˆØ¸Ù...`);
      
      let success = 0, failed = 0;
      
      for(let i=0; i<workers.length; i++) {
          showProgress(Math.round((i / workers.length) * 100), `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... ${i+1} Ù…Ù† ${workers.length}`);
          
          try {
              await sb.from('attendance').insert({
                  worker_id: workers[i],
                  date: date,
                  site_id: siteId || null,
                  status: status,
                  recorded_by: CUR_USER.id,
                  is_approved: false
              });
              success++;
          } catch(e) {
              failed++;
          }
      }
      
      showLoad(false);
      document.getElementById('progressContainer').classList.add('hidden');
      showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${success} Ù…ÙˆØ¸Ù${failed > 0 ? `ØŒ ÙØ´Ù„ ${failed}` : ''}`);
      loadAttendanceRegister();
  }

  async function registerAttendance(workerId, status) {
      const date = document.getElementById('attDate').value;
      const siteId = document.getElementById('attSite').value;
      
      // Check duplicate
      const {data:existing} = await sb.from('attendance')
          .select('id')
          .eq('worker_id',workerId)
          .eq('date',date)
          .single();
      
      if(existing) {
          showToast('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'error');
          loadAttendanceRegister();
          return;
      }
      
      showLoad(true);
      
      try {
          const {error} = await sb.from('attendance').insert({
              worker_id: workerId,
              date: date,
              site_id: siteId || null,
              status: status,
              recorded_by: CUR_USER.id,
              is_approved: false
          });
          
          if(error) {
              if(error.message.includes('unique') || error.code === '23505') {
                  showToast('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'error');
              } else {
                  showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'error');
              }
          } else {
              showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
              // Remove from list visually
              const card = document.getElementById(`worker-${workerId}`);
              if(card) {
                  card.style.opacity = '0';
                  card.style.transform = 'translateX(100%)';
                  setTimeout(() => card.remove(), 300);
              }
          }
      } catch(err) {
          showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
      }
      
      setTimeout(() => loadAttendanceRegister(), 500);
      showLoad(false);
  }

  async function loadAttendanceReview() {
      const date = document.getElementById('reviewDate').value;
      const siteId = document.getElementById('reviewSite').value;
      
      let query = sb.from('attendance').select('*, workers(name,id_number)').eq('date',date);
      if(siteId) query = query.eq('site_id',siteId);
      
      const {data} = await query;
      
      document.getElementById('attendanceReviewList').innerHTML = (data||[]).map(a => `
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:15px;">
          <div>
              <b>${a.workers?.name}</b><br>
              <small style="color:var(--text-light);">${a.workers?.id_number}</small>
          </div>
          <span class="badge ${a.status==='present'?'bg-green':a.status==='absent'?'bg-red':'bg-orange'}">
              ${a.status==='present'?'Ø­Ø§Ø¶Ø±':a.status==='absent'?'ØºØ§Ø¦Ø¨':'Ù†ØµÙ ÙŠÙˆÙ…'}
          </span>
      </div>`).join('') || '<p style="text-align:center; color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>';
  }

  // Approval (Data Entry)
  function initApprovalFilters() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('appDate').value = today;
      document.getElementById('appApprovedDate').value = today;
      
      const userSites = CUR_USER.role === 'admin' ? SITES_CACHE : SITES_CACHE.filter(s => CUR_USER.sites.includes(s.id));
      const opts = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>' + userSites.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      document.getElementById('appSite').innerHTML = opts;
      document.getElementById('appApprovedSite').innerHTML = opts;
  }

  function switchAppTab(t) {
      document.getElementById('app-pending-view').classList.toggle('hidden', t!='pending');
      document.getElementById('app-approved-view').classList.toggle('hidden', t!='approved');
      document.querySelectorAll('#v-approval .sub-tab').forEach((e,i)=>e.classList.toggle('active', (t=='pending'&&i==0)||(t=='approved'&&i==1)));
      if(t=='pending') loadPendingApproval();
      else loadApprovedAttendance();
  }

  async function loadPendingApproval() {
      const date = document.getElementById('appDate').value;
      const siteId = document.getElementById('appSite').value;
      
      let query = sb.from('attendance').select('*, workers(name,id_number), recorders:recorded_by(full_name)').eq('is_approved',false);
      if(date) query = query.eq('date',date);
      if(siteId) query = query.eq('site_id',siteId);
      
      const {data} = await query;
      
      document.getElementById('pendingApprovalList').innerHTML = (data||[]).map(a => `
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:15px;">
          <div style="display:flex; align-items:center; gap:10px;">
              <input type="checkbox" class="pending-checkbox" value="${a.id}" style="width:auto;">
              <div>
                  <b>${a.workers?.name}</b><br>
                  <small style="color:var(--text-light);">${a.workers?.id_number} | ${a.date} | Ù…Ø³Ø¬Ù„: ${a.recorders?.full_name}</small>
              </div>
          </div>
          <div class="flex-row">
              <span class="badge ${a.status==='present'?'bg-green':a.status==='absent'?'bg-red':'bg-orange'}">
                  ${a.status==='present'?'Ø­Ø§Ø¶Ø±':a.status==='absent'?'ØºØ§Ø¦Ø¨':'Ù†ØµÙ ÙŠÙˆÙ…'}
              </span>
              <button onclick="approveAttendance(${a.id}, true)" class="btn-sm btn-green">Ø§Ø¹ØªÙ…Ø§Ø¯</button>
              <button onclick="approveAttendance(${a.id}, false)" class="btn-sm btn-red">Ø±ÙØ¶</button>
          </div>
      </div>`).join('') || '<p style="text-align:center; color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>';
  }

  async function approveAttendance(id, approve) {
      showLoad(true);
      if(approve) {
          await sb.from('attendance').update({is_approved:true, approved_by:CUR_USER.id, approved_at:new Date()}).eq('id',id);
          showToast('ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±');
      } else {
          await sb.from('attendance').delete().eq('id',id);
          showToast('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¶ÙˆØ±');
      }
      loadPendingApproval();
      showLoad(false);
  }

  async function loadApprovedAttendance() {
      const date = document.getElementById('appApprovedDate').value;
      const siteId = document.getElementById('appApprovedSite').value;
      
      let query = sb.from('attendance').select('*, workers(name,id_number), approvers:approved_by(full_name)').eq('is_approved',true);
      if(date) query = query.eq('date',date);
      if(siteId) query = query.eq('site_id',siteId);
      
      const {data} = await query;
      
      document.getElementById('approvedAttendanceList').innerHTML = (data||[]).map(a => `
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:15px;">
          <div>
              <b>${a.workers?.name}</b><br>
              <small style="color:var(--text-light);">${a.workers?.id_number} | ${a.date} | Ù…Ø¹ØªÙ…Ø¯: ${a.approvers?.full_name}</small>
          </div>
          <div class="flex-row">
              <span class="badge ${a.status==='present'?'bg-green':a.status==='absent'?'bg-red':'bg-orange'}">
                  ${a.status==='present'?'Ø­Ø§Ø¶Ø±':a.status==='absent'?'ØºØ§Ø¦Ø¨':'Ù†ØµÙ ÙŠÙˆÙ…'}
              </span>
              <button onclick="requestCorrection(${a.id})" class="btn-sm btn-outline">Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
      </div>`).join('') || '<p style="text-align:center; color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø©</p>';
  }

  async function requestCorrection(attId) {
      const reason = prompt('Ø³Ø¨Ø¨ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:');
      if(!reason) return;
      
      showLoad(true);
      await sb.from('correction_requests').insert({
          attendance_id: attId,
          requester_id: CUR_USER.id,
          reason: reason,
          status: 'pending'
      });
      showLoad(false);
      showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  }

  // Corrections
  async function loadCorrections() {
      const {data} = await sb.from('correction_requests').select('*, attendance(*, workers(name,id_number)), requesters:requester_id(full_name)').eq('status','pending');
      
      document.getElementById('correctionsList').innerHTML = (data||[]).map(c => `
      <div class="card" style="margin-bottom:10px; padding:15px;">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
              <div>
                  <b>Ø·Ù„Ø¨ Ù…Ù†: ${c.requesters?.full_name}</b><br>
                  <small style="color:var(--text-light);">${new Date(c.created_at).toLocaleString('ar-SA')}</small>
              </div>
              <span class="badge bg-orange">Ù…Ø¹Ù„Ù‚</span>
          </div>
          <div style="background:var(--bg-main); padding:10px; border-radius:8px; margin-bottom:10px;">
              <b>Ø§Ù„Ù…ÙˆØ¸Ù:</b> ${c.attendance?.workers?.name} (${c.attendance?.workers?.id_number})<br>
              <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${c.attendance?.date}<br>
              <b>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</b> ${c.attendance?.status==='present'?'Ø­Ø§Ø¶Ø±':c.attendance?.status==='absent'?'ØºØ§Ø¦Ø¨':'Ù†ØµÙ ÙŠÙˆÙ…'}<br>
              <b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${c.reason}
          </div>
          <div class="flex-row">
              <button onclick="approveCorrection(${c.id}, ${c.attendance_id})" class="btn btn-green">Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
              <button onclick="rejectCorrection(${c.id})" class="btn btn-red">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
          </div>
      </div>`).join('') || '<p style="text-align:center; color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>';
  }

  async function approveCorrection(reqId, attId) {
      const {data:att} = await sb.from('attendance').select('*, workers(name)').eq('id',attId).single();
      
      document.getElementById('editAttId').value = att.id;
      document.getElementById('editAttWorker').value = att.workers?.name;
      document.getElementById('editAttDate').value = att.date;
      document.getElementById('editAttStatus').value = att.status;
      
      document.getElementById('editAttendanceModal').classList.add('open');
      await sb.from('correction_requests').update({status:'approved'}).eq('id',reqId);
  }

  async function rejectCorrection(id) {
      if(!confirm('Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
      showLoad(true);
      await sb.from('correction_requests').update({status:'rejected'}).eq('id',id);
      loadCorrections();
      showLoad(false);
  }

  async function saveAttendanceEdit() {
      const id = document.getElementById('editAttId').value;
      const status = document.getElementById('editAttStatus').value;
      
      showLoad(true);
      await sb.from('attendance').update({status:status}).eq('id',id);
      closeModal('editAttendanceModal');
      loadCorrections();
      showLoad(false);
      showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±');
  }

  // Reports - Ù…Ø¹ Ø¯Ø¹Ù… 120 Ø£Ù„Ù Ø³Ø¬Ù„
  function updateReportOptions() {
      const type = document.getElementById('repType').value;
      document.getElementById('repDateRange').style.display = type === 'workers' ? 'none' : 'flex';
  }

  async function genReport() {
      const type = document.getElementById('repType').value;
      const start = document.getElementById('repStart').value;
      const end = document.getElementById('repEnd').value;
      const siteId = document.getElementById('repSite').value;
      const contId = document.getElementById('repCont').value;
      
      if(type !== 'workers' && (!start || !end)) {
          return showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®', 'error');
      }
      
      showLoad(true, 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª');
      
      try {
          if(type === 'workers') {
              await exportWorkersReport(siteId, contId);
          } else if(type === 'attendance_log') {
              await exportAttendanceReport(start, end, siteId);
          } else if(type === 'payroll') {
              await exportPayrollReport(start, end, siteId, contId);
          } else if(type === 'contractor_invoice') {
              await exportContractorReport(start, end, siteId, contId);
          }
      } catch(err) {
          console.error(err);
          showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
      }
      
      showLoad(false);
      document.getElementById('progressContainer').classList.add('hidden');
  }

  async function exportWorkersReport(siteId, contId) {
      let allData = [];
      let from = 0;
      const chunk = 1000;
      
      while(true) {
          showProgress(Math.round((from / (from + 1000)) * 50), `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... ${allData.length}`);
          
          let query = sb.from('workers').select('*, sites(name), contractors(name)').eq('is_active',true);
          if(siteId) query = query.eq('current_site_id',siteId);
          if(contId) query = query.eq('contractor_id',contId);
          
          const {data} = await query.range(from, from + chunk - 1);
          if(!data || data.length === 0) break;
          allData.push(...data);
          if(data.length < chunk) break;
          from += chunk;
      }
      
      const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„Ù…Ø³Ù…Ù‰','Ø§Ù„Ø±Ø§ØªØ¨','Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹','Ø§Ù„Ù…ÙˆÙ‚Ø¹','Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„'];
      const rows = allData.map(w => [
          w.name, w.id_number, w.job_title || '', w.basic_salary || '',
          w.payment_type === 'daily' ? 'ÙŠÙˆÙ…ÙŠØ©' : 'Ø±Ø§ØªØ¨',
          w.sites?.name || '', w.contractors?.name || ''
      ]);
      
      exportToExcel([headers, ...rows], 'Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¹Ù…Ø§Ù„.xlsx');
      showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${allData.length} Ø¹Ø§Ù…Ù„`, 'success');
  }

  async function exportAttendanceReport(start, end, siteId) {
      let allData = [];
      let from = 0;
      const chunk = 5000;
      
      while(true) {
          showProgress(Math.round((from / (from + 5000)) * 50), `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±... ${allData.length}`);
          
          let query = sb.from('attendance').select('*, workers(name,id_number), sites(name)')
              .gte('date',start).lte('date',end).eq('is_approved',true);
          if(siteId) query = query.eq('site_id',siteId);
          
          const {data} = await query.range(from, from + chunk - 1);
          if(!data || data.length === 0) break;
          allData.push(...data);
          if(data.length < chunk) break;
          from += chunk;
      }
      
      const headers = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù…ÙˆÙ‚Ø¹','Ø§Ù„Ø­Ø§Ù„Ø©'];
      const rows = allData.map(a => [
          a.date, a.workers?.id_number, a.workers?.name, 
          a.sites?.name, a.status==='present'?'Ø­Ø§Ø¶Ø±':a.status==='absent'?'ØºØ§Ø¦Ø¨':'Ù†ØµÙ ÙŠÙˆÙ…'
      ]);
      
      exportToExcel([headers, ...rows], 'Ø³Ø¬Ù„_Ø§Ù„Ø­Ø¶ÙˆØ±.xlsx');
      showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${allData.length} Ø³Ø¬Ù„`, 'success');
  }

  async function exportPayrollReport(start, end, siteId, contId) {
      showProgress(10, 'Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨...');
      
      // Get attendance
      let attQuery = sb.from('attendance').select('*, workers(*, sites(name), contractors(name))')
          .gte('date',start).lte('date',end).eq('is_approved',true);
      
      const {data:att} = await attQuery;
      
      // Group by worker
      const workerDays = {};
      (att||[]).forEach(a => {
          if(!workerDays[a.worker_id]) {
              workerDays[a.worker_id] = {
                  worker: a.workers,
                  present: 0,
                  absent: 0,
                  half: 0
              };
          }
          if(a.status === 'present') workerDays[a.worker_id].present++;
          else if(a.status === 'absent') workerDays[a.worker_id].absent++;
          else if(a.status === 'half') workerDays[a.worker_id].half += 0.5;
      });
      
      const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„','Ø§Ù„Ù…ÙˆÙ‚Ø¹','Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±','Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨','Ù†ØµÙ Ø£ÙŠØ§Ù…','Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…','Ø§Ù„ÙŠÙˆÙ…ÙŠØ©','Ø§Ù„Ù…Ø³ØªØ­Ù‚'];
      const rows = Object.values(workerDays).map(w => {
          const totalDays = w.present + w.half;
          const dailyRate = parseFloat(w.worker.basic_salary) || 0;
          const amount = w.worker.payment_type === 'daily' ? totalDays * dailyRate : (totalDays / 30) * dailyRate;
          return [
              w.worker.name, w.worker.id_number, w.worker.contractors?.name, w.worker.sites?.name,
              w.present, w.absent, w.half, totalDays, dailyRate, amount.toFixed(2)
          ];
      });
      
      exportToExcel([headers, ...rows], 'Ù…Ø³ÙŠØ±_Ø§Ù„Ø±ÙˆØ§ØªØ¨.xlsx');
      showToast(`ØªÙ… ØªØµØ¯ÙŠØ± Ù…Ø³ÙŠØ± ${rows.length} Ù…ÙˆØ¸Ù`, 'success');
  }

  async function exportContractorReport(start, end, siteId, contId) {
      let attQuery = sb.from('attendance').select('*, workers(*, contractors(name), sites(name))')
          .gte('date',start).lte('date',end).eq('is_approved',true);
      
      const {data:att} = await attQuery;
      
      // Group by contractor and site
      const contData = {};
      (att||[]).forEach(a => {
          const key = `${a.workers?.contractor_id}_${a.workers?.current_site_id}`;
          if(!contData[key]) {
              contData[key] = {
                  contractor: a.workers?.contractors?.name,
                  site: a.workers?.sites?.name,
                  workers: new Set(),
                  days: 0
              };
          }
          contData[key].workers.add(a.worker_id);
          if(a.status === 'present') contData[key].days++;
          else if(a.status === 'half') contData[key].days += 0.5;
      });
      
      const headers = ['Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„','Ø§Ù„Ù…ÙˆÙ‚Ø¹','Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„','Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…','Ø§Ù„Ù…Ø¨Ù„Øº'];
      const rows = Object.values(contData).map(c => [
          c.contractor, c.site, c.workers.size, c.days, (c.days * 100).toFixed(2)
      ]);
      
      exportToExcel([headers, ...rows], 'Ù…Ø³ØªØ®Ù„Øµ_Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†.xlsx');
      showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${rows.length} Ø¨Ù†Ø¯`, 'success');
  }

  function exportToExcel(data, filename) {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
      XLSX.writeFile(wb, filename);
  }

  // Users
  async function loadUsers() {
      const {data} = await sb.from('app_users').select('*, user_sites(site_id)').order('id');
      USERS_CACHE = data || [];
      
      const sitesOpts = SITES_CACHE.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      document.getElementById('nUSites').innerHTML = sitesOpts;
      document.getElementById('editUSites').innerHTML = sitesOpts;
      
      document.getElementById('usersList').innerHTML = (data||[]).map(u=>{
          const userSites = u.user_sites ? u.user_sites.map(us => {
              const site = SITES_CACHE.find(s => s.id === us.site_id);
              return site?.name;
          }).filter(Boolean).join(', ') : 'ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹';
          
          return `
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:10px;">
          <div>
              <b style="font-size:1.1rem;">${u.full_name}</b><br>
              <small style="color:var(--text-light);">${u.username} | ${getRoleName(u.role)} | Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹: ${userSites}</small>
          </div>
          <div class="flex-row">
              <button onclick="openEditU(${u.id})" class="btn-sm btn-outline">ØªØ¹Ø¯ÙŠÙ„</button>
              <button onclick="openChangePass(${u.id})" class="btn-sm btn-gray">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
              ${u.username!='admin'?`<button onclick="delUser(${u.id})" class="btn-sm btn-red"><i class="fa-solid fa-trash"></i></button>`:''}
          </div>
      </div>`}).join('');
  }

  async function addUser() {
      const u=document.getElementById('nUName').value, 
            p=document.getElementById('nUPass').value, 
            f=document.getElementById('nUFull').value,
            r=document.getElementById('nURole').value;
      
      if(!u||!p||!f) return showToast('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
      
      const sitesSelect = document.getElementById('nUSites');
      const selectedSites = Array.from(sitesSelect.selectedOptions).map(o => o.value);
      
      showLoad(true);
      const {data:user, error} = await sb.from('app_users').insert({ 
          username:u, password:p, full_name:f, role:r 
      }).select().single();
      
      if(error) {
          showLoad(false);
          return showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ±Ø±', 'error');
      }
      
      if(selectedSites.length > 0) {
          await sb.from('user_sites').insert(selectedSites.map(sid => ({
              user_id: user.id,
              site_id: sid
          })));
      }
      
      document.getElementById('nUName').value='';
      document.getElementById('nUPass').value='';
      document.getElementById('nUFull').value='';
      await loadUsers();
      showLoad(false);
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
  }

  function openEditU(id) {
      const u = USERS_CACHE.find(x=>x.id==id);
      document.getElementById('editUId').value=u.id;
      document.getElementById('editUFull').value=u.full_name;
      document.getElementById('editUName').value=u.username;
      document.getElementById('editURole').value=u.role;
      
      const sitesSelect = document.getElementById('editUSites');
      const userSiteIds = u.user_sites ? u.user_sites.map(us => us.site_id) : [];
      Array.from(sitesSelect.options).forEach(opt => {
          opt.selected = userSiteIds.includes(parseInt(opt.value));
      });
      
      document.getElementById('editUserModal').classList.add('open');
  }

  async function saveUserEdit() {
      const id = document.getElementById('editUId').value;
      const selectedSites = Array.from(document.getElementById('editUSites').selectedOptions).map(o => o.value);
      
      showLoad(true);
      
      await sb.from('app_users').update({
          full_name: document.getElementById('editUFull').value,
          role: document.getElementById('editURole').value
      }).eq('id',id);
      
      await sb.from('user_sites').delete().eq('user_id',id);
      if(selectedSites.length > 0) {
          await sb.from('user_sites').insert(selectedSites.map(sid => ({
              user_id: id,
              site_id: sid
          })));
      }
      
      closeModal('editUserModal');
      await loadUsers();
      showLoad(false);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
  }

  function openChangePass(id) {
      document.getElementById('passUId').value = id;
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('changePassModal').classList.add('open');
  }

  async function savePasswordChange() {
      const id = document.getElementById('passUId').value;
      const p1 = document.getElementById('newPassword').value;
      const p2 = document.getElementById('confirmPassword').value;
      
      if(p1 !== p2) return showToast('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†', 'error');
      if(p1.length < 4) return showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©', 'error');
      
      showLoad(true);
      await sb.from('app_users').update({password:p1}).eq('id',id);
      closeModal('changePassModal');
      showLoad(false);
      showToast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  }

  async function delUser(id) {
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      showLoad(true);
      await sb.from('app_users').delete().eq('id',id);
      await loadUsers();
      showLoad(false);
  }

  // Dashboard
  async function loadDashboard() {
      const {count:sitesCount} = await sb.from('sites').select('*',{count:'exact'});
      const {count:workersCount} = await sb.from('workers').select('*',{count:'exact'}).eq('is_active',true);
      const {count:contsCount} = await sb.from('contractors').select('*',{count:'exact'});
      
      const today = new Date().toISOString().split('T')[0];
      const {count:todayAtt} = await sb.from('attendance').select('*',{count:'exact'}).eq('date',today);
      
      document.getElementById('dashSites').innerText = sitesCount || 0;
      document.getElementById('dashWorkers').innerText = workersCount || 0;
      document.getElementById('dashConts').innerText = contsCount || 0;
      document.getElementById('dashTodayAtt').innerText = todayAtt || 0;
      
      const {data:recentWorkers} = await sb.from('workers').select('*,sites(name)').order('id',{ascending:false}).limit(5);
      document.getElementById('dashRecentWorkers').innerHTML = (recentWorkers||[]).map(w=>`
          <div style="padding:10px; border-bottom:1px solid var(--border-color);">
              <b>${w.name}</b> - <small style="color:var(--text-light);">${w.sites?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
          </div>
      `).join('') || '<p style="color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>';
      
      const {data:corrections} = await sb.from('correction_requests').select('*').eq('status','pending').limit(5);
      document.getElementById('dashPendingCorrections').innerHTML = (corrections||[]).map(c=>`
          <div style="padding:10px; border-bottom:1px solid var(--border-color);">
              <span class="badge bg-orange">Ù…Ø¹Ù„Ù‚</span> <small>${new Date(c.created_at).toLocaleDateString('ar-SA')}</small>
          </div>
      `).join('') || '<p style="color:var(--text-light);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
  }

  // Roles
  function loadRoles() {
      // Ø§Ù„ØµÙØ­Ø© Ø«Ø§Ø¨ØªØ©ØŒ Ù…ÙÙŠØ´ Ø­Ø§Ø¬Ø© ØªØªØ­Ù…Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
      console.log('Roles page loaded');
  }

  // Init
  window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      ['repStart','repEnd'].forEach(id => {
          const el=document.getElementById(id);
          if(el) el.value=today;
      });
      
      const chk = document.getElementById('editWActive');
      if(chk) {
          chk.onchange = function() {
              const txt = document.getElementById('activeStatusText');
              txt.innerText = this.checked ? 'Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ';
              txt.className = this.checked ? 'badge bg-green' : 'badge bg-gray';
          };
      }
  };
</script>
</body>
</html>
